# Advanced RVC Inference - Setup Guide\n\n## Quick Setup for Enhanced Features\n\n### 1. Install New Dependencies\n\n```bash\n# Update requirements\npip install -r requirements.txt\n\n# Add real-time processing support\npip install sounddevice\n\n# Optional: For enhanced audio processing\npip install torchcrepe torchfcpe\n```\n\n### 2. Verify Installation\n\n```python\n# Test KRVC kernel\nfrom advanced_rvc_inference.krvc_kernel import krvc_speed_optimize\nkrvc_speed_optimize()\n\n# Test F0 extraction\nfrom advanced_rvc_inference.tabs.f0_extractor import f0_extractor\nprint(f\"F0 Extractor initialized: {f0_extractor.device}\")\n\n# Test embedder manager\nfrom advanced_rvc_inference.tabs.embedders import embedder_manager\nprint(f\"Available models: {len(embedder_manager.list_available_models())}\")\n```\n\n### 3. Enhanced Features Usage\n\n#### F0 Extraction with Multiple Methods\n```python\nfrom advanced_rvc_inference.tabs.f0_extractor import f0_extractor\n\n# Neural network methods\nf0_fcpe, info = f0_extractor.extract_f0(audio, sr, \"fcpe\")\nf0_crepe, info = f0_extractor.extract_f0(audio, sr, \"crepe\")\n\n# Hybrid methods\nf0_hybrid, info = f0_extractor.extract_f0(audio, sr, \"hybrid[rmvpe+crepe+fcpe]\")\n\n# Traditional methods with post-processing\nf0_processed, info = f0_extractor.extract_f0(audio, sr, \"rmvpe-medfilt\")\n```\n\n#### Advanced Embedding Extraction\n```python\nfrom advanced_rvc_inference.tabs.embedders import embedder_manager\n\n# Extract embeddings with different models\nembeddings_contentvec = embedder_manager.extract_embeddings(audio, sr, \"contentvec\")\nembeddings_spin_v2 = embedder_manager.extract_embeddings(audio, sr, \"spin-v2\")\nembeddings_whisper = embedder_manager.extract_embeddings(audio, sr, \"whisper-medium\")\n\n# Get model information\ninfo = embedder_manager.get_model_info(\"spin-v2\")\nprint(f\"SPIN v2: {info['description']}\")\n```\n\n#### Real-time Voice Conversion\n```python\nfrom advanced_rvc_inference.core import real_time_voice_conversion\n\n# Start real-time conversion (requires microphone)\nresult = real_time_voice_conversion(\n    model_path=\"your_model.pth\",\n    index_path=\"your_index.index\", \n    embedder_model=\"contentvec\",\n    pitch_extract=\"fcpe\",\n    pitch=0,\n    chunk_size=2048\n)\n```\n\n### 4. Performance Optimization\n\n#### Enable KRVC Optimizations\n```python\nfrom advanced_rvc_inference.krvc_kernel import (\n    krvc_inference_mode,\n    KRVCPerformanceMonitor\n)\n\n# Enable inference optimizations\nkrvc_inference_mode()\n\n# Monitor performance\nmonitor = KRVCPerformanceMonitor()\nstats = monitor.get_stats()\nprint(f\"Performance stats: {stats}\")\n```\n\n#### GPU Memory Management\n```python\nfrom advanced_rvc_inference.krvc_kernel import cleanup_krvc_memory\n\n# Clean up GPU memory\ncleanup_krvc_memory()\n```\n\n### 5. Model Compatibility\n\nThe system automatically maps Vietnamese-RVC models:\n\n```python\nfrom advanced_rvc_inference.core import map_embedder_model, map_pitch_extractor\n\n# These mappings are handled automatically\nmapped_embedder = map_embedder_model(\"vietnamese-hubert-base\")\nmapped_pitch = map_pitch_extractor(\"mangio-crepe\")\n\nprint(f\"Mapped embedder: {mapped_embedder}\")\nprint(f\"Mapped pitch: {mapped_pitch}\")\n```\n\n### 6. Troubleshooting\n\n#### Common Issues\n\n1. **CUDA Out of Memory**\n   ```python\n   # Reduce batch size or use CPU\n   f0_extractor = AdvancedF0Extractor(device=\"cpu\")\n   ```\n\n2. **Missing Dependencies**\n   ```bash\n   pip install torchcrepe torchfcpe sounddevice\n   ```\n\n3. **Real-time Processing Issues**\n   ```python\n   # Check audio device\n   import sounddevice as sd\n   print(sd.query_devices())\n   ```\n\n#### Performance Tips\n\n1. **Use appropriate F0 methods**:\n   - FCPE: Best speed/quality balance\n   - CREPE: Highest quality, slower\n   - RMVPE: Fast traditional method\n\n2. **Optimize embedder selection**:\n   - ContentVec: Good multilingual support\n   - SPIN v2: Enhanced performance\n   - Whisper models: Language-specific quality\n\n3. **Memory management**:\n   - Clear GPU cache regularly\n   - Use smaller batch sizes for long audio\n   - Enable mixed precision when possible\n\n### 7. Integration Examples\n\n#### Full Inference Pipeline\n```python\nfrom advanced_rvc_inference.core import full_inference_program\n\n# Complete voice conversion with all enhancements\nresult = full_inference_program(\n    model_path=\"model.pth\",\n    index_path=\"model.index\",\n    input_audio_path=\"input.wav\",\n    output_path=\"output.wav\",\n    # Enhanced parameters\n    pitch_extract=\"hybrid[fcpe+rmvpe]\",\n    embedder_model=\"spin-v2\",\n    # Audio processing\n    denoise=True,\n    reverb=True,\n    # Performance\n    batch_size=1,\n    devices=\"0\"\n)\n```\n\n### 8. Advanced Configuration\n\n#### Custom KRVC Settings\n```python\nfrom advanced_rvc_inference.krvc_kernel import PERFORMANCE_MODE\n\n# Customize performance settings\nPERFORMANCE_MODE.update({\n    \"cuda_memory_fraction\": 0.9,\n    \"mixed_precision\": True,\n    \"quantization\": True\n})\n```\n\n### 9. Monitoring and Debugging\n\n```python\nimport logging\n\n# Enable detailed logging\nlogging.basicConfig(level=logging.DEBUG)\n\n# Monitor F0 extraction\nf0_values, info = f0_extractor.extract_f0(audio, sr, method)\nprint(f\"Extraction info: {info}\")\n\n# Monitor embedding extraction\nembeddings = embedder_manager.extract_embeddings(audio, sr, model_name)\nprint(f\"Embedding shape: {embeddings.shape}\")\n```\n\n### 10. Best Practices\n\n1. **Audio Preprocessing**:\n   - Normalize audio levels\n   - Resample to 16kHz if needed\n   - Remove silence if not needed\n\n2. **Model Selection**:\n   - Match embedder to content language\n   - Use FCPE for real-time applications\n   - Combine methods for challenging audio\n\n3. **Performance Optimization**:\n   - Cache frequently used models\n   - Use appropriate chunk sizes\n   - Monitor memory usage\n\n4. **Quality Assurance**:\n   - Test with various audio types\n   - Validate F0 extraction accuracy\n   - Compare different method outputs\n\nThis setup guide ensures you can take full advantage of all the enhanced features in the improved Advanced RVC Inference system.\n